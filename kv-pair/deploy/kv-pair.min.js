class kvPair extends HTMLElement{static observedAttributes=["src","pair","labels"];constructor(){super(),this.addEventListener("click",this.#e),this.addEventListener("keydown",this.#e),this.addEventListener("focusout",this.#e),this.addEventListener("focusin",this.#e),this.innerHTML=`<menu role="list" data-bit="0"><label></label></menu><menu role="list" data-bit="1"><label></label></menu><input type="hidden" name="${this.getAttribute("name")||"kv-pair"}">`,this.removeAttribute("name"),this.children[0].addEventListener("scroll",this.#e),this.children[0].addEventListener("scrollend",this.#e),this.children[1].addEventListener("scroll",this.#e),this.children[1].addEventListener("scrollend",this.#e)}async#t(e){return await fetch(e).then((e=>e.json())).then((e=>e)).catch((()=>["",""]))}async attributeChangedCallback(e,t,l){if(t==l)return;if("pair"==e)return this.setAttribute("pair","true"==l?"true":"false"),void(this.children[1].style.display="true"==l?"":"none");if("labels"==e)return this.children[0].querySelector("label").innerText=l.split(",")[0],void(this.children[1].querySelector("label").innerText=l.split(",")[1]);const i="["==l[0]?JSON.parse(l):await this.#t(l),s=(i[0]||"").split(","),n=(i[1]||"").split(","),r=Math.max(s.length,n.length);for(;s.length<r;)s.push("");for(;n.length<r;)n.push("");const a=this.getAttribute("labels")?.split(",")||["",""];this.children[0].innerHTML=`<label>${a[0]?a[0]:""} â†»</label>`+s.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),this.children[1].innerHTML=`<label>${a[1]?a[1]:""}</label>`+n.map((e=>`<div role="listitem" contenteditable>${e}</div>`)).join(""),i[1]||(this.children[1].style.display="none"),this.#l()}#e(e){const t="click"===e.type&&!e.target.previousElementSibling;if(e.key){if(-1==["Enter",",","Tab","ArrowDown","ArrowUp"].indexOf(e.key))return;e.preventDefault()}if("focusin"==e.type||"focusout"==e.type&&null==e.relatedTarget)return void this.querySelectorAll(".selected").forEach((e=>e.className=""));let l=e.relatedTarget||e.target;"scroll"!=e.type&&"scrollend"!=e.type&&"MENU"==l.tagName&&(l=l.lastChild,l.focus());const i=l.closest("menu")||this.querySelector("menu"),s=this.closest("kv-pair").querySelector(`menu[data-bit="${"0"==i.dataset.bit?"1":"0"}"]`);if("scroll"==e.type||"scrollend"==e.type)return void(s.scrollTop=i.scrollTop);this.querySelectorAll(".selected").forEach((e=>e.className=""));let n=0;for(;l.previousElementSibling;l=l.previousElementSibling,++n);switch(e.key){case"ArrowDown":n=n<i.children.length-1?n+2:2;case"ArrowUp":n=n>1?n-1:i.children.length-1,this.#i(i.children[n]),s.children[n].className="selected";break;case"Tab":this.#i(s.children[n]),s.children[n].className="",i.children[n].className="selected";break;case"Enter":i.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),s.insertAdjacentHTML("beforeend",'<div role="listitem" contenteditable></div>'),n=i.children.length-1,this.#i(i.children[n]),s.children[n].className="selected";break;default:n&&n<s.children.length&&(s.children[n].className="selected")}this.#l(t),s.scrollTop=i.scrollTop}#i(e){e.focus();const t=document.getSelection(),l=document.createRange();l.selectNodeContents(e),t.removeAllRanges(),t.addRange(l)}#s(e){const t=e[0].split(","),l=e[1].split(","),i=new Set,s=[];for(let e=0;e<t.length;e++)i.has(t[e])||(s.push([t[e],l[e]]),i.add(t[e]));const n=!/[^0-9.,]/.test(e[0]);s.sort(((e,t)=>n?Number(e[0])-Number(t[0]):e[0].localeCompare(t[0])));return[s.map((e=>e[0])).join(","),s.map((e=>e[1])).join(",")]}#l(e=!1){const t=[[...this.children[0].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.trim().replaceAll("\n",""))).join(",").replace(/,+$/g,""),[...this.children[1].querySelectorAll('[role="listitem"]')].map((e=>e.innerText.trim().replaceAll("\n",""))).join(",").replace(/,+$/g,"")];e?(this.children[2].value=JSON.stringify(this.#s(t)),this.attributeChangedCallback("","",this.children[2].value)):this.children[2].value=JSON.stringify(t)}}customElements.define("kv-pair",kvPair);